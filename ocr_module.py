#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Enhanced Thai OCR with Gemini API
‡πÉ‡∏ä‡πâ Google Gemini Vision API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OCR ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
"""

import os
import re
import base64
from pathlib import Path
import google.generativeai as genai

# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF
try:
    import PyPDF2
    import fitz  # PyMuPDF
    PDF_SUPPORT = True
except ImportError:
    PDF_SUPPORT = False
    print("‚ö†Ô∏è  PDF libraries not installed. Install with:")
    print("   pip install PyPDF2 PyMuPDF")


class GeminiThaiDocumentOCR:
    def __init__(self, api_key=None):
        """
        Initialize Gemini OCR
        
        Parameters:
        -----------
        api_key : str, optional
            Google API key. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å environment variable GOOGLE_API_KEY
        """
        self.api_key = api_key or os.getenv('GOOGLE_API_KEY')
        if not self.api_key:
            raise ValueError(
                "‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ API key ‡∏ú‡πà‡∏≤‡∏ô parameter ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ environment variable GOOGLE_API_KEY\n"
                "‡∏£‡∏±‡∏ö API key ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà: https://makersuite.google.com/app/apikey"
            )
        
        genai.configure(api_key=self.api_key)
        self.model = genai.GenerativeModel('gemini-1.5-flash')
        
        self.thai_digits = {
            '0': '‡πê', '1': '‡πë', '2': '‡πí', '3': '‡πì', '4': '‡πî',
            '5': '‡πï', '6': '‡πñ', '7': '‡πó', '8': '‡πò', '9': '‡πô'
        }

    # ============================================================
    # üîπ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö PDF ‡∏°‡∏µ text layer ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    # ============================================================
    def check_pdf_has_text(self, pdf_path):
        if not PDF_SUPPORT:
            return False

        try:
            with open(pdf_path, 'rb') as file:
                pdf_reader = PyPDF2.PdfReader(file)
                pages_to_check = min(3, len(pdf_reader.pages))
                for i in range(pages_to_check):
                    page = pdf_reader.pages[i]
                    text = page.extract_text()
                    thai_chars = len(re.findall(r'[‡∏Å-‡∏Æ‡∏∞-‡πå]', text))
                    if thai_chars > 50:
                        return True
            return False
        except Exception as e:
            print(f"Error checking PDF: {e}")
            return False

    # ============================================================
    # üîπ Extract text ‡∏à‡∏≤‡∏Å PDF ‡∏ó‡∏µ‡πà‡∏°‡∏µ text layer
    # ============================================================
    def extract_text_from_pdf(self, pdf_path):
        if not PDF_SUPPORT:
            raise ImportError("PyPDF2 not installed")

        print("‚úì PDF has text layer - extracting directly...")
        try:
            with open(pdf_path, 'rb') as file:
                pdf_reader = PyPDF2.PdfReader(file)
                all_text = []
                for i, page in enumerate(pdf_reader.pages):
                    print(f"  Page {i+1}/{len(pdf_reader.pages)}")
                    text = page.extract_text()
                    all_text.append(text)
                return '\n\n'.join(all_text)
        except Exception as e:
            print(f"‚úó Error extracting text: {e}")
            return None

    # ============================================================
    # üîπ ‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û (‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ text layer)
    # ============================================================
    def pdf_to_images(self, pdf_path, output_folder='temp_pages', dpi=300):
        if not PDF_SUPPORT:
            raise ImportError("PyMuPDF not installed")

        print(f"Converting PDF to images (DPI={dpi})...")
        os.makedirs(output_folder, exist_ok=True)

        try:
            doc = fitz.open(pdf_path)
            image_paths = []
            for page_num in range(len(doc)):
                page = doc[page_num]
                zoom = dpi / 72
                mat = fitz.Matrix(zoom, zoom)
                pix = page.get_pixmap(matrix=mat, alpha=False)
                output_path = os.path.join(output_folder, f'page_{page_num+1}.png')
                pix.save(output_path)
                image_paths.append(output_path)
                print(f"  ‚úì Page {page_num+1}/{len(doc)} saved: {output_path}")
            doc.close()
            return image_paths
        except Exception as e:
            print(f"‚úó Error converting PDF: {e}")
            return []

    # ============================================================
    # üîπ OCR ‡∏î‡πâ‡∏ß‡∏¢ Gemini Vision API
    # ============================================================


    def ocr_with_gemini(self, image_path):
        """‡πÉ‡∏ä‡πâ Gemini Vision API ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û"""
        try:
            print(f"üì∏ Processing with Gemini API: {os.path.basename(image_path)}")
            
            with open(image_path, 'rb') as f:
                image_data = f.read()
            
            # ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö prompt ‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏£‡∏∞ "‡∏≥" ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
            prompt = """‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô OCR expert ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    
    üéØ **‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à:** ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á 100%
    
    ‚ö†Ô∏è **‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î - ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∞ "‡∏≥":**
    
    ‡∏™‡∏£‡∏∞ "‡∏≥" (SARA AM / ‚óå‡∏≥) ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏£‡∏∞‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏≤" + "‡∏°" ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô
    
    ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Å‡∏≤ + ‡∏´‡∏ô‡∏î, ‡∏™‡∏≤ + ‡∏Ñ‡∏±‡∏ç, ‡∏Ñ‡∏≤ + ‡∏™‡∏±‡πà‡∏á, ‡∏ó‡∏≤ + ‡∏Å‡∏≤‡∏£
    ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î, ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç, ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á, ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£
    
    **‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©:**
    - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î, ‡∏Å‡∏≥‡∏•‡∏±‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏Å‡∏≤‡∏´‡∏ô‡∏î, ‡∏Å‡∏≤‡∏•‡∏±‡∏á)
    - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç, ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö, ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤, ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à, ‡∏™‡∏≥‡∏ô‡∏±‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏™‡∏≤‡∏Ñ‡∏±‡∏ç, ‡∏™‡∏≤‡∏´‡∏£‡∏±‡∏ö...)
    - ‡∏Ñ‡∏≥, ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á, ‡∏Ñ‡∏≥‡∏ô‡∏≥, ‡∏Ñ‡∏≥‡∏Ç‡∏≠, ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏Ñ‡∏≤, ‡∏Ñ‡∏≤‡∏™‡∏±‡πà‡∏á...)
    - ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£, ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏ó‡∏≤‡∏Å‡∏≤‡∏£, ‡∏ó‡∏≤‡∏á‡∏≤‡∏ô)
    - ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô, ‡∏î‡∏≥‡∏£‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏î‡∏≤‡πÄ‡∏ô‡∏¥‡∏ô, ‡∏î‡∏≤‡∏£‡∏á)
    - ‡∏ô‡∏≥, ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏ô‡∏≤, ‡∏ô‡∏≤‡πÄ‡∏™‡∏ô‡∏≠)
    - ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á, ‡∏ï‡∏≥‡∏£‡∏ß‡∏à (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏ï‡∏≤‡πÅ‡∏´‡∏ô‡πà‡∏á, ‡∏ï‡∏≤‡∏£‡∏ß‡∏à)
    - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡πÄ‡∏£‡πá‡∏à)
    
    **‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:**
    - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞ + ‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡∏≠‡∏≥" ‚Üí ‡πÉ‡∏ä‡πâ "‡∏≥"
    - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô "‡∏≤" ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ "‡∏°" ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏á‡∏™‡∏±‡∏¢ ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô "‡∏≥" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    
    **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡πÜ:**
    1. ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà, ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)
    2. ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠: ‡∏ä‡∏à‡∏ç.‡∏ô‡∏õ. / ‡∏ú‡∏™.‡∏™‡∏™‡∏ö‡∏õ. / ‡∏ö‡∏ô‡∏õ.
    3. ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: ‡πÄ‡∏≠‡πá‡∏ô‡∏ó‡∏µ / ‡∏®‡∏ò / ‡∏ô‡∏ó
    4. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: 15 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2568 (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
    
    **‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢**"""
            
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Gemini API
            response = self.model.generate_content([
                prompt,
                {
                    'mime_type': 'image/png' if image_path.lower().endswith('.png') else 'image/jpeg',
                    'data': image_data
                }
            ])
            
            text = response.text.strip()
            
            # ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° post-processing ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            text = self.post_process_thai_document(text)
            
            thai_chars = len(re.findall(r'[‡∏Å-‡∏Æ‡∏∞-‡πå]', text))
            confidence = min(95.0, 70.0 + (thai_chars / 10))
            
            print(f"  ‚úì Extracted {len(text)} characters ({thai_chars} Thai chars)")
            
            return {
                'text': text,
                'confidence': confidence
            }
            
        except Exception as e:
            print(f"  ‚úó Gemini API Error: {e}")
            return None
 
        
     

    # ============================================================
    # üîπ Post-processing ‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢
    # ============================================================


    def post_process_thai_document(self, text):
        """
        Post-processing ‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢ ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏™‡∏£‡∏∞ ‡∏≥ ‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î
        """
        import re
        result = text
        
        # ==========================================
        # üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏£‡∏∞ "‡∏≥" ‡∏ó‡∏µ‡πà OCR ‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô "‡∏≤" + "‡∏°"
        # ==========================================
        sara_am_fixes = {
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏à"
            '‡∏à‡∏≤‡∏ô‡∏ß‡∏ô': '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
            '‡∏à‡∏≤‡πÄ‡∏õ‡πá‡∏ô': '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô',
            '‡∏à‡∏≤‡πÅ‡∏ô‡∏Å': '‡∏à‡∏≥‡πÅ‡∏ô‡∏Å',
            '‡∏à‡∏≤‡∏Å‡∏±‡∏î': '‡∏à‡∏≥‡∏Å‡∏±‡∏î',
            '‡∏à‡∏≤‡∏´‡∏ô‡πà‡∏≤‡∏¢': '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢',
            '‡∏à‡∏≤‡∏•‡∏≠‡∏á': '‡∏à‡∏≥‡∏•‡∏≠‡∏á',
            '‡∏à‡∏≤‡πÄ‡∏•‡∏¢': '‡∏à‡∏≥‡πÄ‡∏•‡∏¢',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏Å"
            '‡∏Å‡∏≤‡∏´‡∏ô‡∏î': '‡∏Å‡∏≥‡∏´‡∏ô‡∏î',
            '‡∏Å‡∏≤‡∏•‡∏±‡∏á': '‡∏Å‡∏≥‡∏•‡∏±‡∏á',
            '‡∏Å‡∏≤‡πÑ‡∏£': '‡∏Å‡∏≥‡πÑ‡∏£',
            '‡∏Å‡∏≤‡πÄ‡∏ô‡∏¥‡∏î': '‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î',
            '‡∏Å‡∏≤‡∏à‡∏±‡∏î': '‡∏Å‡∏≥‡∏à‡∏±‡∏î',
            '‡∏Å‡∏≤‡∏û‡∏£‡πâ‡∏≤': '‡∏Å‡∏≥‡∏û‡∏£‡πâ‡∏≤',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏Ç"
            '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô': '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô',  # ‡∏ô‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏ä"
            '‡∏ä‡∏≤‡∏£‡∏∞': '‡∏ä‡∏≥‡∏£‡∏∞',
            '‡∏ä‡∏≤‡∏ô‡∏≤‡∏ç': '‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç',
            '‡∏ä‡∏≤‡πÄ‡∏£‡∏≤': '‡∏ä‡∏≥‡πÄ‡∏£‡∏≤',
            '‡∏ä‡∏≤‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô': '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏î"
            '‡∏î‡∏≤‡πÄ‡∏ô‡∏¥‡∏ô': '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô',
            '‡∏î‡∏≤‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
            '‡∏î‡∏≤‡∏£‡∏á': '‡∏î‡∏≥‡∏£‡∏á',
            '‡∏î‡∏≤‡∏£‡∏¥': '‡∏î‡∏≥‡∏£‡∏¥',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏ï"
            '‡∏ï‡∏≤‡πÅ‡∏´‡∏ô‡πà‡∏á': '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
            '‡∏ï‡∏≤‡∏£‡∏ß‡∏à': '‡∏ï‡∏≥‡∏£‡∏ß‡∏à',
            '‡∏ï‡∏≤‡∏ö‡∏•': '‡∏ï‡∏≥‡∏ö‡∏•',
            '‡∏ï‡∏≤‡∏´‡∏ô‡∏¥': '‡∏ï‡∏≥‡∏´‡∏ô‡∏¥',
            '‡∏ï‡∏≤‡∏£‡∏≤‡∏á': '‡∏ï‡∏≤‡∏£‡∏≤‡∏á',  # ‡∏ô‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏ô"
            '‡∏ô‡∏≤‡πÄ‡∏™‡∏ô‡∏≠': '‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠',
            '‡∏ô‡∏≤‡∏°‡∏≤': '‡∏ô‡∏≥‡∏°‡∏≤',
            '‡∏ô‡∏≤‡πÑ‡∏õ': '‡∏ô‡∏≥‡πÑ‡∏õ',
            '‡∏ô‡∏≤‡∏™‡πà‡∏á': '‡∏ô‡∏≥‡∏™‡πà‡∏á',
            '‡∏ô‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤': '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤',
            '‡∏ô‡∏≤‡∏≠‡∏≠‡∏Å': '‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏õ"
            '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',  # ‡∏ô‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏ú"
            '‡∏ú‡∏≤‡πÄ‡∏™‡∏∑‡πâ‡∏≠': '‡∏ú‡πâ‡∏≤‡πÄ‡∏™‡∏∑‡πâ‡∏≠',  # ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏ú‡πâ‡∏≤" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏ú‡∏≥"
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏£"
            '‡∏£‡∏≤‡∏Ñ‡∏≤': '‡∏£‡∏≤‡∏Ñ‡∏≤',  # ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            '‡∏£‡∏≤‡∏°‡∏≤': '‡∏£‡∏≤‡∏°‡∏≤',  # ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞
            '‡∏£‡∏∞‡∏ö‡∏≤': '‡∏£‡∏∞‡∏ö‡∏≥',  # ‡∏£‡∏∞‡∏ö‡∏≥
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏•"
            '‡∏•‡∏≤‡∏û‡∏±‡∏á': '‡∏•‡∏≥‡∏û‡∏±‡∏á',
            '‡∏•‡∏≤‡∏î‡∏±‡∏ö': '‡∏•‡∏≥‡∏î‡∏±‡∏ö',
            '‡∏•‡∏≤‡∏ö‡∏≤‡∏Å': '‡∏•‡∏≥‡∏ö‡∏≤‡∏Å',
            '‡∏•‡∏≤‡πÄ‡∏•‡∏µ‡∏¢‡∏á': '‡∏•‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏á',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏™"
            '‡∏™‡∏≤‡∏Ñ‡∏±‡∏ç': '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç',
            '‡∏™‡∏≤‡∏´‡∏£‡∏±‡∏ö': '‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö',
            '‡∏™‡∏≤‡πÄ‡∏ô‡∏≤': '‡∏™‡∏≥‡πÄ‡∏ô‡∏≤',
            '‡∏™‡∏≤‡πÄ‡∏£‡πá‡∏à': '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            '‡∏™‡∏≤‡∏ô‡∏±‡∏Å': '‡∏™‡∏≥‡∏ô‡∏±‡∏Å',
            '‡∏™‡∏≤‡∏ô‡∏ß‡∏ô': '‡∏™‡∏≥‡∏ô‡∏ß‡∏ô',
            '‡∏™‡∏≤‡∏£‡∏ß‡∏à': '‡∏™‡∏≥‡∏£‡∏ß‡∏à',
            '‡∏™‡∏≤‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ': '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ',
            '‡∏™‡∏≤‡∏ó‡∏ó': '‡∏™‡∏≥‡∏ô‡∏±‡∏Å',
            '‡∏™‡∏≤‡πÅ‡∏î‡∏á': '‡∏™‡∏≥‡πÅ‡∏î‡∏á',
            '‡∏™‡∏≤‡πÄ‡∏ô‡∏µ‡∏¢‡∏á': '‡∏™‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏á',
            '‡∏™‡∏≤‡πÄ‡∏†‡∏≤': '‡∏™‡∏≥‡πÄ‡∏†‡∏≤',
            '‡∏™‡∏≤‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á': '‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á',
            '‡∏™‡∏≤‡∏•‡∏µ': '‡∏™‡∏≤‡∏•‡∏µ',  # ‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏•‡∏µ - ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏´"
            '‡∏´‡∏≤‡∏ô‡∏ß‡∏¢': '‡∏´‡∏≥‡∏ô‡∏ß‡∏¢',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏≠"
            '‡∏≠‡∏≤‡∏û‡∏±‡∏ô': '‡∏≠‡∏≥‡∏û‡∏±‡∏ô',
            '‡∏≠‡∏≤‡∏û‡∏£‡∏≤‡∏á': '‡∏≠‡∏≥‡∏û‡∏£‡∏≤‡∏á',
            '‡∏≠‡∏≤‡∏ô‡∏≤‡∏à': '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à',
            '‡∏≠‡∏≤‡∏ô‡∏ß‡∏¢': '‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢',
            '‡∏≠‡∏≤‡πÄ‡∏†‡∏≠': '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏Ñ‡∏≥" (‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
            '‡∏Ñ‡∏≤‡∏ô‡∏≥': '‡∏Ñ‡∏≥‡∏ô‡∏≥',
            '‡∏Ñ‡∏≤‡∏™‡∏±‡πà‡∏á': '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á',
            '‡∏Ñ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥': '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥',
            '‡∏Ñ‡∏≤‡∏Ç‡∏≠': '‡∏Ñ‡∏≥‡∏Ç‡∏≠',
            '‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á': '‡∏Ñ‡∏≥‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á',
            '‡∏Ñ‡∏≤‡∏£‡∏∞‡∏ö‡∏∏': '‡∏Ñ‡∏≥‡∏£‡∏∞‡∏ö‡∏∏',
            '‡∏Ñ‡∏≤‡∏£‡πâ‡∏≠‡∏á': '‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á',
            '‡∏Ñ‡∏≤‡∏ï‡∏≠‡∏ö': '‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö',
            '‡∏Ñ‡∏≤‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤': '‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤',
            '‡∏Ñ‡∏≤‡πÅ‡∏ñ‡∏•‡∏á': '‡∏Ñ‡∏≥‡πÅ‡∏ñ‡∏•‡∏á',
            '‡∏Ñ‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢': '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢',
            '‡∏Ñ‡∏≤‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô': '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
            '‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠': '‡∏Ñ‡∏≥‡πÄ‡∏™‡∏ô‡∏≠',
            '‡∏Ñ‡∏≤‡πÅ‡∏õ‡∏•': '‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•',
            '‡∏Ñ‡∏≤‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á': '‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á',
            '‡∏Ñ‡∏≤‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢': '‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢',
            '‡∏Ñ‡∏≤‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤': '‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤',
            '‡∏Ñ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®': '‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
            '‡∏Ñ‡∏≤‡∏û‡∏π‡∏î': '‡∏Ñ‡∏≥‡∏û‡∏π‡∏î',
            '‡∏Ñ‡∏≤‡∏ñ‡∏≤‡∏°': '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°',
            '‡∏Ñ‡∏≤‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢': '‡∏Ñ‡∏≥‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢',
            '‡∏Ñ‡∏≤‡∏≠‡∏∏‡∏ó‡∏ò‡∏£‡∏ì‡πå': '‡∏Ñ‡∏≥‡∏≠‡∏∏‡∏ó‡∏ò‡∏£‡∏ì‡πå',
            '‡∏Ñ‡∏≤‡∏ô‡∏ß‡∏ì': '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì',
            '‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏î': '‡∏Ñ‡∏≥‡∏Ç‡∏≤‡∏î',
            '‡∏Ñ‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢': '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏ó‡∏≥"
            '‡∏ó‡∏≤‡∏Å‡∏≤‡∏£': '‡∏ó‡∏≥‡∏Å‡∏≤‡∏£',
            '‡∏ó‡∏≤‡∏á‡∏≤‡∏ô': '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
            '‡∏ó‡∏≤‡πÉ‡∏´‡πâ': '‡∏ó‡∏≥‡πÉ‡∏´‡πâ',
            '‡∏ó‡∏≤‡πÑ‡∏î‡πâ': '‡∏ó‡∏≥‡πÑ‡∏î‡πâ',
            '‡∏ó‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°': '‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°',
            '‡∏ó‡∏≤‡∏•‡∏≤‡∏¢': '‡∏ó‡∏≥‡∏•‡∏≤‡∏¢',
            '‡∏ó‡∏≤‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö': '‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö',
            '‡∏ó‡∏≤‡πÄ‡∏õ‡πá‡∏ô': '‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô',
            '‡∏ó‡∏≤‡πÑ‡∏ß‡πâ': '‡∏ó‡∏≥‡πÑ‡∏ß‡πâ',
            '‡∏ó‡∏≤‡πÅ‡∏•‡πâ‡∏ß': '‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß',
            
            # ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏£‡∏ß‡∏° "‡∏Ñ‡∏ß‡∏≤‡∏°..."
            '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏Ñ‡∏±‡∏ç': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç',
            '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡πÄ‡∏£‡πá‡∏à': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡πÄ‡∏õ‡πá‡∏ô': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô',
            
            # ‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£
            '‡∏≠‡∏≤‡∏á‡∏ñ‡∏∂‡∏á': '‡∏≠‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á',
            '‡πÄ‡∏£‡∏ó‡∏≠‡∏á': '‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á',
            '‡∏ß‡∏ó‡∏ó‡∏µ‡πà': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
            '‡∏ñ‡∏ó': '‡∏ñ‡∏∂‡∏á',
            
            # ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
            '‡∏Å‡∏ó': '‡∏Å‡∏≥',
            '‡∏Ñ‡∏ó‡∏∞': '‡∏Ñ‡∏ì‡∏∞',
        }
        
        # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î (‡∏ó‡∏≥ 2 ‡∏£‡∏≠‡∏ö)
        for wrong, correct in sara_am_fixes.items():
            result = result.replace(wrong, correct)
        
        # ==========================================
        # üîç Pattern-based fixing (‡πÉ‡∏ä‡πâ regex) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        # ==========================================
        
        common_patterns = [
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏à
            (r'‡∏à‡∏≤(‡∏ô‡∏ß‡∏ô|‡πÄ‡∏õ‡πá‡∏ô|‡πÅ‡∏ô‡∏Å|‡∏Å‡∏±‡∏î|‡∏´‡∏ô‡πà‡∏≤‡∏¢|‡∏•‡∏≠‡∏á|‡πÄ‡∏•‡∏¢)', r'‡∏à‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏Å
            (r'‡∏Å‡∏≤(‡∏´‡∏ô‡∏î|‡∏•‡∏±‡∏á|‡πÑ‡∏£|‡πÄ‡∏ô‡∏¥‡∏î|‡∏à‡∏±‡∏î|‡∏û‡∏£‡πâ‡∏≤)', r'‡∏Å‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏ä
            (r'‡∏ä‡∏≤(‡∏£‡∏∞|‡∏ô‡∏≤‡∏ç|‡πÄ‡∏£‡∏≤)', r'‡∏ä‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏î
            (r'‡∏î‡∏≤(‡πÄ‡∏ô‡∏¥‡∏ô|‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£|‡∏£‡∏á|‡∏£‡∏¥)', r'‡∏î‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏ï
            (r'‡∏ï‡∏≤(‡πÅ‡∏´‡∏ô‡πà‡∏á|‡∏£‡∏ß‡∏à|‡∏ö‡∏•|‡∏´‡∏ô‡∏¥)', r'‡∏ï‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏ô
            (r'‡∏ô‡∏≤(‡πÄ‡∏™‡∏ô‡∏≠|‡∏°‡∏≤|‡πÑ‡∏õ|‡∏™‡πà‡∏á|‡πÄ‡∏Ç‡πâ‡∏≤|‡∏≠‡∏≠‡∏Å)', r'‡∏ô‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏•
            (r'‡∏•‡∏≤(‡∏û‡∏±‡∏á|‡∏î‡∏±‡∏ö|‡∏ö‡∏≤‡∏Å|‡πÄ‡∏•‡∏µ‡∏¢‡∏á)', r'‡∏•‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏™
            (r'‡∏™‡∏≤(‡∏Ñ‡∏±‡∏ç|‡∏´‡∏£‡∏±‡∏ö|‡πÄ‡∏ô‡∏≤|‡πÄ‡∏£‡πá‡∏à|‡∏ô‡∏±‡∏Å|‡∏ô‡∏ß‡∏ô|‡∏£‡∏ß‡∏à|‡πÅ‡∏î‡∏á|‡πÄ‡∏ô‡∏µ‡∏¢‡∏á|‡πÄ‡∏†‡∏≤)', r'‡∏™‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏≠
            (r'‡∏≠‡∏≤(‡∏û‡∏±‡∏ô|‡∏û‡∏£‡∏≤‡∏á|‡∏ô‡∏≤‡∏à|‡∏ô‡∏ß‡∏¢|‡πÄ‡∏†‡∏≠)', r'‡∏≠‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏Ñ‡∏≥ (‡∏à‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥)
            (r'‡∏Ñ‡∏≤([‡∏ô‡∏™‡∏Ç‡∏£‡∏ï‡∏û‡πÅ‡∏≠‡πÄ‡∏ä‡∏ö‡∏õ‡∏ß‡∏≠‡∏Å‡∏ñ][‡∏Å-‡πô]*)', r'‡∏Ñ‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏ó‡∏≥
            (r'‡∏ó‡∏≤(‡∏Å‡∏≤‡∏£|‡∏á‡∏≤‡∏ô|‡πÉ‡∏´‡πâ|‡πÑ‡∏î‡πâ|‡∏Ñ‡∏ß‡∏≤‡∏°|‡∏•‡∏≤‡∏¢|‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö|‡πÄ‡∏õ‡πá‡∏ô|‡πÑ‡∏ß‡πâ|‡πÅ‡∏•‡πâ‡∏ß)', r'‡∏ó‡∏≥\1'),
            # ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏Ñ‡∏ß‡∏≤‡∏°
            (r'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤(‡∏Ñ‡∏±‡∏ç|‡πÄ‡∏£‡πá‡∏à)', r'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥\1'),
            (r'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤(‡πÄ‡∏õ‡πá‡∏ô)', r'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥\1'),
        ]
        
        for pattern, replacement in common_patterns:
            result = re.sub(pattern, replacement, result)
        
        # ==========================================
        # ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        # ==========================================
        
        # ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô
        result = re.sub(r'([‡∏Å-‡∏Æ])\s+([‡∏∞-‡∏π])', r'\1\2', result)
        result = re.sub(r'([‡∏±-‡∏π])\s+([‡∏Å-‡∏Æ])', r'\1\2', result)
        result = re.sub(r' +', ' ', result)
        result = re.sub(r'\n\s*\n\s*\n+', '\n\n', result)
        
        # ‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
        unit_corrections = {
            "‡∏ä‡∏≤‡∏ç.‡πÉ‡∏ô‡∏õ.": "‡∏ä‡∏à‡∏ç.‡∏ô‡∏õ.",
            "‡∏ä‡∏≤‡∏ô.‡∏ô‡∏õ.": "‡∏ä‡∏à‡∏ç.‡∏ô‡∏õ.",
            "‡∏ä‡∏≤‡∏ç.‡∏ô‡∏õ.": "‡∏ä‡∏à‡∏ç.‡∏ô‡∏õ.",
            "‡∏ú‡∏™.‡∏™‡∏™‡∏û‡∏ö‡∏õ.": "‡∏ú‡∏™.‡∏™‡∏™‡∏ö‡∏õ.",
            "‡∏ú‡∏™.‡∏™‡∏™‡∏û‡∏õ.": "‡∏ú‡∏™.‡∏™‡∏™‡∏ö‡∏õ.", 
            "‡∏ú‡∏™.‡∏•‡∏ô‡∏õ.": "‡∏ú‡∏™.‡∏ô‡∏õ.",
            "‡∏ú‡∏™.‡∏ö‡∏•‡∏ô.": "‡∏ú‡∏™.‡∏ö‡∏ô‡∏õ.",
            "‡∏ö‡∏•‡∏ô‡∏õ.": "‡∏ö‡∏ô‡∏õ.", 
            "‡∏ä‡∏≤‡∏ô.‡πÉ‡∏ô‡∏õ.": "‡∏ä‡∏à‡∏ç.‡∏ô‡∏õ.",
            "‡∏ú‡∏™.‡∏™‡∏ö‡πÉ‡∏ô‡∏õ.": "‡∏ú‡∏™.‡∏™‡∏ö‡∏ô‡∏õ.", 
        }
        
        for wrong, correct in unit_corrections.items():
            result = result.replace(wrong, correct)
        
        # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö (double-check)
        for wrong, correct in sara_am_fixes.items():
            result = result.replace(wrong, correct)
        
        return result.strip()

  

    # ============================================================
    # üîπ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
    # ============================================================
    def extract_key_fields(self, text):
        """‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢"""
        fields = {}
    
        # ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
        match = re.search(
            r'(?:‡∏ö\s*)?(?:‡πÄ[‡∏≠‡∏ô][‡πá‡∏ô]‡∏ó‡∏µ|‡πÄ‡∏≠‡πá‡∏ô‡∏ó‡∏µ|‡∏®‡∏ò|‡∏ô‡∏ó|‡∏á‡∏õ|‡∏Ñ‡∏™|‡∏ô‡∏û|‡∏ú‡∏™)\S*\/\S*(?:\s*‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà\s*\d{1,2}\s*[‡∏Å-‡πô]+\s*\d{4})?',
            text
        )
        if match:
            number_text = match.group(0).strip()
            number_text = re.sub(r'^‡∏ö\s*', '', number_text)
            if not number_text.startswith("‡πÄ‡∏≠‡πá‡∏ô‡∏ó‡∏µ"):
                number_text = re.sub(r'^(‡πÄ[‡∏≠‡∏ô][‡πá‡∏ô]‡∏ó‡∏µ)', '‡πÄ‡∏≠‡πá‡∏ô‡∏ó‡∏µ', number_text)
                if not number_text.startswith("‡πÄ‡∏≠‡πá‡∏ô‡∏ó‡∏µ"):
                    number_text = f"‡πÄ‡∏≠‡πá‡∏ô‡∏ó‡∏µ{number_text}"
            fields["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠"] = number_text
        else:
            match = re.search(r'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà[:\s]*([^\n]+)', text)
            if match:
                num = match.group(1).strip()
                if not num.startswith("‡πÄ‡∏≠‡πá‡∏ô‡∏ó‡∏µ"):
                    num = f"‡πÄ‡∏≠‡πá‡∏ô‡∏ó‡∏µ{num}"
                fields['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠'] = num
    
        # ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
        match = re.search(r'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà[:\s]*([^\n]+)', text)
        if match:
            fields['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠'] = match.group(1).strip()
    
        # ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
        match = re.search(r'‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á[:\s]*([^\n]+(?:\n(?!\s*‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)[^\n]+)*)', text)
        if match:
            fields['‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á'] = match.group(1).strip()
    
        # ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        match = re.search(r'‡πÄ‡∏£‡∏µ‡∏¢‡∏ô[:\s]*([^\n]+)', text)
        if match:
            fields['‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] = match.group(1).strip()
    
        # ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (5 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å)
        body_match = re.search(r'‡πÄ‡∏£‡∏µ‡∏¢‡∏ô[:\s]*[^\n]+\n(.*)', text, re.DOTALL)
        if body_match:
            body_lines = body_match.group(1).strip().splitlines()
            preview = "\n".join(body_lines[:5])
            preview = re.sub(r'\s{2,}', ' ', preview)
            fields['‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤'] = preview.strip()
    
        return fields

    # ============================================================
    # üîπ Pipeline ‡∏´‡∏•‡∏±‡∏Å
    # ============================================================
    def process_document(self, file_path):
        """
        ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á PDF ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û)
        
        Parameters:
        -----------
        file_path : str
            path ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
            
        Returns:
        --------
        dict : ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå OCR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        """
        print(f"\n{'='*60}\nProcessing: {file_path}\n{'='*60}\n")
        is_pdf = file_path.lower().endswith('.pdf')

        # PDF mode
        if is_pdf and PDF_SUPPORT:
            # ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á text layer ‡∏Å‡πà‡∏≠‡∏ô
            if self.check_pdf_has_text(file_path):
                text = self.extract_text_from_pdf(file_path)
                if text:
                    cleaned = self.post_process_thai_document(text)
                    return {
                        'text': cleaned,
                        'key_fields': self.extract_key_fields(cleaned),
                        'method': 'PDF text layer',
                        'confidence': 100.0
                    }

            # ‡πÑ‡∏°‡πà‡∏°‡∏µ text layer -> ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û
            print("‚úì No text layer found - converting to images for OCR...")
            imgs = self.pdf_to_images(file_path, dpi=300)
            results = []
            
            for img in imgs:
                if img:
                    result = self.ocr_with_gemini(img)
                    if result:
                        results.append(result)
            
            if not results:
                return None
                
            # ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
            combined = '\n\n--- ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ---\n\n'.join(r['text'] for r in results)
            avg_conf = sum(r['confidence'] for r in results) / len(results)
            cleaned = self.post_process_thai_document(combined)
            
            return {
                'text': cleaned,
                'key_fields': self.extract_key_fields(cleaned),
                'method': 'PDF OCR (Gemini)',
                'confidence': avg_conf,
                'pages': len(results)
            }

        # Image mode
        result = self.ocr_with_gemini(file_path)
        if not result:
            return None
            
        cleaned = self.post_process_thai_document(result['text'])
        return {
            'text': cleaned,
            'key_fields': self.extract_key_fields(cleaned),
            'method': 'Image OCR (Gemini)',
            'confidence': result['confidence']
        }


# ============================================================
# üî∏ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
# ============================================================
if __name__ == "__main__":
    # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API key (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏î‡∏ß‡∏¥‡∏ò‡∏µ‡∏´‡∏ô‡∏∂‡πà‡∏á)
    
    # ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô parameter
    # ocr = GeminiThaiDocumentOCR(api_key="YOUR_API_KEY_HERE")
    
    # ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ environment variable (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
    # export GOOGLE_API_KEY="your_api_key_here"
    ocr = GeminiThaiDocumentOCR()
    
    # ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå
    test_file = "document.pdf"  # ‡∏´‡∏£‡∏∑‡∏≠ "document.png"
    
    try:
        result = ocr.process_document(test_file)
        
        if result:
            print("\n" + "="*60)
            print("=== OCR SUCCESS ===")
            print("="*60)
            print(f"Method: {result.get('method')}")
            print(f"Confidence: {result['confidence']:.2f}%")
            
            if 'pages' in result:
                print(f"Pages: {result['pages']}")
            
            print("\n--- Key Fields ---")
            for key, value in result['key_fields'].items():
                print(f"{key}: {value}")
            
            print("\n--- Full Text (Preview) ---")
            preview_text = result['text'][:1000]
            print(preview_text)
            if len(result['text']) > 1000:
                print(f"\n... (total {len(result['text'])} characters)")
                
    except Exception as e:
        print(f"‚ùå Error: {e}")
        import traceback
        traceback.print_exc()





